---
# Load data
- import_playbook: data.yml

- name: Store a password in Credential Manager
  hosts: domain
  vars:
    credentials: "{{ lab.hosts[dict_key].credentials | default([]) }}"
    domain: "{{lab.hosts[dict_key].domain}}"
    ansible_user: "{{lab.domains[domain].domain_username}}@{{domain | upper}}"
    ansible_password: "{{lab.domains[domain].domain_password}}"
    ansible_winrm_transport: kerberos
    ansible_become: yes
    ansible_become_method: runas
    ansible_become_user: "{{item.value.runas | default(domain_username) }}"
    ansible_become_password: "{{item.value.runas_password | default(domain_password) }}"
  tasks:
    - name: Store a password in Credential Manager
      community.windows.win_credential:
        name: "{{item.key}}"
        type: domain_password
        username: "{{item.value.username}}"
        secret: "{{item.value.secret}}"
        comment: "Credential for {{item.value.username}}"
        persistence: local
        state: present
      with_dict: "{{ credentials }}"