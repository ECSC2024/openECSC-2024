---
- name: Setup Ansible
  hosts: all
  tasks:
    - name: Install necessary Python packages
      pip:
        name:
          - ansible
          - pywinrm
          - pywinrm[kerberos]
        state: present

    - name: Remove Ansible directory
      file:
        path: /home/deploy/lab
        state: absent
        force: yes

    - name: Copy Ansible directory
      copy:
        src: "{{ playbook_dir }}/../lab"
        dest: /home/deploy
        force: yes

    - name: Make sync.sh executable
      file:
        path: /home/deploy/lab/sync.sh
        mode: 0755

    - name: Install Ansible galaxy requirements
      command: /home/deploy/.local/bin/ansible-galaxy install -r /home/deploy/lab/requirements.yml

    - name: Copy Kerberos configuration krb5.conf
      become: yes
      copy:
        src: "{{ playbook_dir }}/files/krb5.conf"
        dest: /etc/krb5.conf
        owner: root
        group: root
        mode: 0644

    - name: Copy DNS/hosts configuration
      become: yes
      copy:
        src: "{{ playbook_dir }}/files/hosts"
        dest: /etc/hosts
        owner: root
        group: root
        mode: 0644
