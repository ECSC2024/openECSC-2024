<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/css/bootstrap.min.css"
          integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>

    <title>Remote Diagnostics Client Spawner</title>
    <style>
        html,
        body {
            height: 100%;
        }

        body {
            padding-top: 40px;
            padding-bottom: 40px;
            background-color: #f5f5f5;
        }

        .form-spawn {
            width: 100%;
            max-width: 350px;
        }

        .form-spawn .form-control {
            position: relative;
            box-sizing: border-box;
            height: auto;
            padding: 10px;
            font-size: 16px;
        }

        .form-spawn .form-control:focus {
            z-index: 2;
        }
    </style>
</head>

<body class="text-center d-flex align-items-center justify-content-center">
    <div class="d-flex flex-column align-items-center" style="max-width: 550px;">
        <h1 class="h3 mb-4 font-weight-normal">Remote Diagnostics Client Spawner</h1>
        <div class="alert alert-info mb-3 w-100" role="alert" id="info-box" style="display: none;">
            <div class="d-flex justify-content-between">
                <b>Endpoint:</b>
                <span id="endpoint">example.com</span>
            </div>
            <div class="d-flex justify-content-between">
                <b>Queue position:</b>
                <span id="queue-position">0</span>
            </div>
            <div class="spinner-border text-info mt-2" style="width: 1.5rem; height: 1.5rem;" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
        <div class="alert alert-danger mb-3 w-100" role="alert" id="error-box" style="display: none;">
            <span id="error-message">Error message</span>
        </div>
        <div class="alert alert-success mb-3 w-100" role="alert" id="success-box" style="display: none;">
            <span id="success-message">Success message</span>
        </div>
        <form class="form-spawn">
            <div class="text-left">
                <label for="inputEndpoint">Your server endpoint</label>
                <input type="text" id="inputEndpoint" class="form-control" placeholder="example.com:1234" required
                       autofocus>
            </div>
            <div class="mt-3 d-flex align-items-center justify-content-center">
                <div class="g-recaptcha" data-sitekey="<public key>"></div>
            </div>
            <button class="btn btn-lg btn-primary btn-block mt-3" id="submit-btn" type="submit">Spawn</button>
        </form>
    </div>
    <script>
        function showErrorMessage(message) {
            document.querySelector('#error-message').innerText = message;
            document.querySelector('#error-box').style.display = 'block';
        }
        function hideErrorMessage() {
            document.querySelector('#error-box').style.display = 'none';
        }
        function addToSessionStorage(value) {
            sessionStorage.setItem("current", JSON.stringify(value));
        }
        function getCurrent() {
            const current = sessionStorage.getItem("current");
            if (current === null) return null;
            return JSON.parse(current);
        }
        function showCurrent() {
            const current = getCurrent();
            if (current) {
                document.querySelector('#info-box').style.display = 'block';
                document.querySelector('#endpoint').innerText = current.endpoint;
                document.querySelector('#queue-position').innerText = current.position;
            }
        }
        function hideCurrent() {
            sessionStorage.removeItem("current");
            document.querySelector('#info-box').style.display = 'none';
        }
        function pollCurrent() {
            const current = getCurrent();
            if (current === null) {
                return;
            }
            fetch('/api/queue/' + current.id).then(res => {
                if (res.ok) {
                    res.json().then(data => {
                        addToSessionStorage(data);
                        showCurrent();
                    });
                } else {
                    if (res.status === 404) {
                        // Dequeued
                        sessionStorage.removeItem("current");
                        hideCurrent();
                        showSuccessMessage('Request dequeued. Spawning in a few seconds... Good luck!');
                    } else if (res.status === 400) {
                        res.json().then(data => {
                            showErrorMessage(data.message);
                        });
                    } else {
                        showErrorMessage('Unknown error: ' + res.statusText);
                    }
                }
            }).catch(err => {
                showErrorMessage('Network error: ' + err.message);
            });
        }
        function showSuccessMessage(message) {
            document.querySelector('#success-message').innerText = message;
            document.querySelector('#success-box').style.display = 'block';
        }
        function hideSuccessMessage() {
            document.querySelector('#success-box').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', function () {
            showCurrent();
            setInterval(pollCurrent, 5000);
        });

        document.querySelector('.form-spawn').addEventListener('submit', function (e) {
            e.preventDefault();

            hideErrorMessage();
            hideSuccessMessage();

            const endpoint = document.querySelector('#inputEndpoint').value;
            const captcha = grecaptcha.getResponse();

            if (!captcha) {
                showErrorMessage('Please complete the captcha');
                return;
            }

            document.querySelector('#submit-btn').disabled = true;

            fetch('/api/queue', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ endpoint, captcha })
            }).then(res => {
                grecaptcha.reset();

                if (res.ok) {
                    document.querySelector('#info-box').style.display = 'none';
                    document.querySelector('#error-box').style.display = 'none';
                    res.json().then(data => {
                        addToSessionStorage(data);
                        showCurrent();
                    });
                } else {
                    if (res.status === 400) {
                        res.json().then(data => {
                            showErrorMessage(data.error);
                        });
                    } else {
                        showErrorMessage('Unknown error: ' + res.statusText);
                    }
                }
            }).catch(err => {
                showErrorMessage('Network error: ' + err.message);
            }).finally(() => {
                document.querySelector('#submit-btn').disabled = false;
            });
        });
    </script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
            integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.6/dist/umd/popper.min.js"
            integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/js/bootstrap.min.js"
            integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k"
            crossorigin="anonymous"></script>
</body>

</html>